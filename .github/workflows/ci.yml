name: Python Accounting App CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pytest
      
      - name: Check file structure
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          echo ""
          echo "ğŸ“„ æ–‡ä»¶æ£€æŸ¥:"
          if [ -f "main.py" ]; then
            echo "âœ… main.py å­˜åœ¨"
            echo "ğŸ“Š main.py åŸºæœ¬ä¿¡æ¯:"
            head -20 main.py
          else
            echo "âŒ main.py ä¸å­˜åœ¨"
          fi
      
      - name: Run basic Python tests
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶
          python -c "
print('ğŸ”§ å¼€å§‹åŸºç¡€æµ‹è¯•...')

# æµ‹è¯•1: PythonåŸºç¡€åŠŸèƒ½
try:
    x = 1 + 1
    assert x == 2
    print('âœ… æµ‹è¯•1: åŸºç¡€æ•°å­¦è¿ç®—é€šè¿‡')
except AssertionError:
    print('âŒ æµ‹è¯•1å¤±è´¥')
    exit(1)

# æµ‹è¯•2: å¦‚æœæœ‰main.pyï¼Œæ£€æŸ¥åŸºæœ¬è¯­æ³•
try:
    import sys
    import os
    sys.path.insert(0, os.getcwd())
    
    if os.path.exists('main.py'):
        # åªæ£€æŸ¥è¯­æ³•ï¼Œä¸æ‰§è¡Œ
        with open('main.py', 'r') as f:
            content = f.read()
        
        # ç¼–è¯‘æ£€æŸ¥è¯­æ³•
        compile(content, 'main.py', 'exec')
        print('âœ… æµ‹è¯•2: main.py è¯­æ³•æ£€æŸ¥é€šè¿‡')
    else:
        print('âš ï¸  æµ‹è¯•2: main.py ä¸å­˜åœ¨ï¼Œè·³è¿‡è¯­æ³•æ£€æŸ¥')
        
except SyntaxError as e:
    print(f'âŒ æµ‹è¯•2: main.py è¯­æ³•é”™è¯¯: {e}')
    exit(1)
except Exception as e:
    print(f'âš ï¸  æµ‹è¯•2: å…¶ä»–é”™è¯¯: {e}')

print('ğŸ‰ æ‰€æœ‰åŸºç¡€æµ‹è¯•é€šè¿‡ï¼')
          "
      
      - name: Create and run simple unit tests
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„å•å…ƒæµ‹è¯•æ–‡ä»¶
          echo "å¼€å§‹åˆ›å»ºå•å…ƒæµ‹è¯•..."
          
          # ä½¿ç”¨å¤šè¡ŒPythonä»£ç åˆ›å»ºæµ‹è¯•æ–‡ä»¶
          python3 << "PYTEST"
import sys
import os

# åˆ›å»ºæµ‹è¯•ç›®å½•
test_dir = "tests"
os.makedirs(test_dir, exist_ok=True)

# åˆ›å»ºç®€å•çš„æµ‹è¯•æ–‡ä»¶
test_content = '''
import sys
import os

def test_placeholder():
    """å ä½æµ‹è¯•ï¼Œç¡®ä¿æµ‹è¯•æ¡†æ¶å·¥ä½œ"""
    assert 1 + 1 == 2
    print("âœ… å ä½æµ‹è¯•é€šè¿‡")

if __name__ == "__main__":
    test_placeholder()
'''

test_file = os.path.join(test_dir, "test_basic.py")
with open(test_file, "w") as f:
    f.write(test_content)

print(f"âœ… æµ‹è¯•æ–‡ä»¶å·²åˆ›å»º: {test_file}")

# è¿è¡Œæµ‹è¯•
sys.path.insert(0, os.getcwd())
try:
    from tests.test_basic import test_placeholder
    test_placeholder()
    print("âœ… æµ‹è¯•å¯¼å…¥å’Œæ‰§è¡ŒæˆåŠŸ")
except Exception as e:
    print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
    sys.exit(1)
PYTEST
      
      - name: Run pytest
        run: |
          # è¿è¡Œpytest
          echo "è¿è¡Œpytest..."
          python -m pytest tests/ -v