name: Python Accounting App CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pytest
      
      - name: Create stripped-down main.py for testing
        run: |
          # åˆ›å»ºä¸åŒ…å«PyQt5çš„æµ‹è¯•ç‰ˆæœ¬
          python -c "
# è¯»å–åŽŸå§‹main.pyå†…å®¹
with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# æå–æ ¸å¿ƒç±»å®šä¹‰ï¼ˆRecordå’ŒTagï¼‰
lines = content.split('\n')
core_classes = []
in_record_class = False
in_tag_class = False
imports = ['from enum import Enum', 'from datetime import datetime']

for line in lines:
    # æ”¶é›†éœ€è¦çš„import
    if line.strip().startswith('from enum import'):
        imports[0] = line.strip()
    elif line.strip().startswith('from datetime import'):
        imports[1] = line.strip()
    
    # æ”¶é›†Tagç±»
    if 'class Tag(Enum):' in line:
        in_tag_class = True
    if in_tag_class:
        core_classes.append(line)
        if line.strip() == '' and len(core_classes) > 10:  # ç®€å•åˆ¤æ–­Tagç±»ç»“æŸ
            in_tag_class = False
    
    # æ”¶é›†Recordç±»
    if 'class Record:' in line and 'def __init__' not in line:
        in_record_class = True
    if in_record_class:
        core_classes.append(line)
        if 'def get_display_text' in line:
            # æ‰¾åˆ°get_display_textæ–¹æ³•åŽç»§ç»­æ”¶é›†ç›´åˆ°æ–¹æ³•ç»“æŸ
            pass
        if line.strip() == '' and 'def get_display_text' in '\n'.join(core_classes[-5:]):
            # ç®€å•åˆ¤æ–­Recordç±»ç»“æŸ
            in_record_class = False

# å†™å…¥æµ‹è¯•ç‰ˆæœ¬
with open('test_main.py', 'w', encoding='utf-8') as f:
    f.write('\n'.join(imports))
    f.write('\n\n')
    f.write('\n'.join(core_classes))
    f.write('\n')

print('âœ… åˆ›å»ºäº†æµ‹è¯•ç‰ˆæœ¬ test_main.py')
          "
      
      - name: Create and run basic tests
        run: |
          python -c "
import sys
sys.path.insert(0, '.')

try:
    # å°è¯•å¯¼å…¥æµ‹è¯•ç‰ˆæœ¬
    from test_main import Record, Tag
    
    print('âœ… æˆåŠŸå¯¼å…¥Recordå’ŒTagç±»')
    
    # æµ‹è¯•1: åˆ›å»ºRecordå¯¹è±¡
    record1 = Record(True, 1000, Tag.SALARY, \"2024-01-01 12:00\", \"\")
    assert record1.number == 1000
    assert record1.in_or_out == True
    assert record1.tag == Tag.SALARY
    print('âœ… æµ‹è¯•1: Recordå¯¹è±¡åˆ›å»ºæˆåŠŸ')
    
    # æµ‹è¯•2: æµ‹è¯•get_display_textæ–¹æ³•
    display_text = record1.get_display_text()
    assert \"æ”¶å…¥\" in display_text
    assert \"1000å…ƒ\" in display_text
    assert \"å·¥èµ„\" in display_text
    print(f'âœ… æµ‹è¯•2: æ˜¾ç¤ºæ–‡æœ¬æ ¼å¼æ­£ç¡® - {display_text}')
    
    # æµ‹è¯•3: æµ‹è¯•è‡ªå®šä¹‰æ ‡ç­¾
    record2 = Record(False, 500, Tag.CUSTOM, \"2024-01-01 13:00\", \"å¨±ä¹\")
    assert record2.tag == Tag.CUSTOM
    assert record2.custom_tag == \"å¨±ä¹\"
    print('âœ… æµ‹è¯•3: è‡ªå®šä¹‰æ ‡ç­¾åŠŸèƒ½æ­£å¸¸')
    
    # æµ‹è¯•4: æµ‹è¯•æ‰€æœ‰æ ‡ç­¾
    tags = [Tag.SALARY, Tag.AWARD, Tag.FOOD, Tag.CLOTHES, Tag.HOUSE, Tag.TRAFFIC, Tag.CUSTOM]
    for tag in tags:
        record = Record(True, 100, tag, \"2024-01-01 14:00\", \"\")
        assert record.tag == tag
    print('âœ… æµ‹è¯•4: æ‰€æœ‰æ ‡ç­¾ç±»åž‹æ­£å¸¸å·¥ä½œ')
    
    print('ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼')
    
except ImportError as e:
    print(f'âŒ å¯¼å…¥é”™è¯¯: {e}')
    sys.exit(1)
except AssertionError as e:
    print(f'âŒ æµ‹è¯•å¤±è´¥: {e}')
    sys.exit(1)
except Exception as e:
    print(f'âŒ å…¶ä»–é”™è¯¯: {e}')
    sys.exit(1)
          "
      
      - name: Create pytest test file
        run: |
          cat > test_accounting.py << 'EOF'
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# å°è¯•å¯¼å…¥æµ‹è¯•ç‰ˆæœ¬
try:
    from test_main import Record, Tag
    IMPORT_SUCCESS = True
except ImportError:
    IMPORT_SUCCESS = False

def test_import():
    """æµ‹è¯•æ˜¯å¦èƒ½æˆåŠŸå¯¼å…¥æ ¸å¿ƒç±»"""
    assert IMPORT_SUCCESS, "æ— æ³•å¯¼å…¥Recordå’ŒTagç±»"

def test_record_creation():
    """æµ‹è¯•Recordå¯¹è±¡åˆ›å»º"""
    if not IMPORT_SUCCESS:
        return
    record = Record(True, 1000, Tag.SALARY, "2024-01-01 12:00", "")
    assert record.number == 1000
    assert record.in_or_out == True
    assert record.tag == Tag.SALARY

def test_record_display():
    """æµ‹è¯•æ˜¾ç¤ºæ–‡æœ¬ç”Ÿæˆ"""
    if not IMPORT_SUCCESS:
        return
    record = Record(True, 1000, Tag.SALARY, "2024-01-01 12:00", "")
    text = record.get_display_text()
    assert "æ”¶å…¥" in text
    assert "1000å…ƒ" in text

def test_custom_tag():
    """æµ‹è¯•è‡ªå®šä¹‰æ ‡ç­¾"""
    if not IMPORT_SUCCESS:
        return
    record = Record(False, 500, Tag.CUSTOM, "2024-01-01 13:00", "å¨±ä¹")
    assert record.custom_tag == "å¨±ä¹"
    assert record.tag == Tag.CUSTOM

if __name__ == "__main__":
    # ç®€å•è¿è¡Œæµ‹è¯•
    test_import()
    test_record_creation()
    test_record_display()
    test_custom_tag()
    print("æ‰€æœ‰æµ‹è¯•é€šè¿‡")
EOF
      
      - name: Run pytest tests
        run: |
          python -m pytest test_accounting.py -v